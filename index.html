<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="author" content="Pieter De Clercq - http://users.ugent.be/~piedcler/"/>
    <meta name="description" content="Scriptingtalen Project - Schuifpuzzel"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Schuifpuzzel</title>

    <link href="assets/bower/bootswatch/flatly/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <link href="assets/bower/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <link href="assets/css/stylesheet.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript">
        var api = "http://localhost:8000/";
    </script>
</head>
<body>
<div class="container" style="padding-top:20px;display:none" id="screen_game">
    <div class="row">
        <div class="col-md-12 col-lg-7">
            <div class="panel panel-primary" style="display: none;" id="game_panel_puzzle_puzzle">
                <div class="panel-heading">
                    <h3 class="panel-title">Puzzle</h3>
                </div>
                <table class="table" id="game_puzzle">
                    <tbody></tbody>
                </table>
            </div>
            <div class="panel panel-primary" id="game_panel_puzzle_loading">
                <div class="panel-heading">
                    <h3 class="panel-title">Puzzle</h3>
                </div>
                <div class="panel-body">
                    <div class="fountainGContainer">
                        <div class="fountainG fountainG_1"></div>
                        <div class="fountainG fountainG_2"></div>
                        <div class="fountainG fountainG_3"></div>
                        <div class="fountainG fountainG_4"></div>
                        <div class="fountainG fountainG_5"></div>
                        <div class="fountainG fountainG_6"></div>
                        <div class="fountainG fountainG_7"></div>
                        <div class="fountainG fountainG_8"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-12 col-lg-5">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="panel-title" id="game_artistName"></h3>
                </div>
                <div class="panel-body" id="game_artistInfo"></div>
            </div>
        </div>
    </div>
</div>
<div class="container" style="padding-top:20px" id="screen_init">
    <div class="row">
        <div class="col-md-6 col-md-offset-3">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="panel-title">Puzzle</h3>
                </div>
                <table class="table">
                    <tbody>
                    <tr>
                        <td style="width:80%">
                            <label for="init_artistName" class="sr-only">Artist:</label>
                            <input type="text" class="form-control" autofocus data-form="initForm" id="init_artistName"
                                   placeholder="Artist"/></td>
                        <td><a class="btn btn-primary" data-submit="initForm" id="init_doSearch" style="width:100%"><i
                                class="fa fa-search"></i></a></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<div class="container" style="padding-top:20px;display:none" id="screen_loading">
    <div class="row">
        <div class="col-md-6 col-md-offset-3">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="panel-title">Puzzle</h3>
                </div>
                <div class="panel-body" style="text-align:center">
                    <div class="fountainGContainer">
                        <div class="fountainG fountainG_1"></div>
                        <div class="fountainG fountainG_2"></div>
                        <div class="fountainG fountainG_3"></div>
                        <div class="fountainG fountainG_4"></div>
                        <div class="fountainG fountainG_5"></div>
                        <div class="fountainG fountainG_6"></div>
                        <div class="fountainG fountainG_7"></div>
                        <div class="fountainG fountainG_8"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript" src="assets/bower/jquery/dist/jquery.min.js"></script>
<script type="text/javascript" src="assets/bower/bootstrap/dist/js/bootstrap.min.js"></script>
<script type="text/javascript" src="assets/bower/snippetjs/src/String.js"></script>
<script type="text/javascript" src="assets/js/betterstrap.js"></script>
<script type="text/javascript" src="assets/js/puzzle.js"></script>
<script type="text/javascript" src="assets/js/layoutmanager.js"></script>
<script type="text/javascript" src="assets/js/eventhandlers.js"></script>
<script type="text/javascript">
    function doPuzzle(folder, ext, rows, cols) {
        var puzzleBox = $("#game_puzzle").find("tbody"), puzzleRow;

        puzzleBox.html("");

        for (var r = 0; r < rows; r += 1) {
            puzzleRow = "";
            for (var c = 0; c < cols; c += 1) {
                if (r != rows - 1 || c != rows - 1) {
                    puzzleRow += '<td data-row="{2}" data-col="{3}" class="no-padding"><img src="{0}{1}/{2}_{3}.{4}" style="width:100%;height:auto"/></td>'.format(api, folder, r, c, ext);
                } else {
                    puzzleRow += '<td data-row="{0}" data-col="{1}" class="no-padding"></td>'.format(r, c);
                }
            }
            puzzleBox.append('<tr>' + puzzleRow + "</tr>");
        }
    }

    function doGetPuzzle(artist, rows, cols) {
        $.getJSON(api + "cgi-bin/puzzle.py", "artiest={0}&rijen={1}&kolommen={2}".format(artist, rows, cols), function (resp) {
            if (resp.success) {
                divSwitch(panels.game_puzzle_loading, panels.game_puzzle_puzzle, function () {
                    doPuzzle(resp.content.directoryname, resp.content.extension, rows, cols);
                });
            } else {
                alert("no puzzle was found. see issue");
            }
        });
    }

    function doSearch(artist) {
        divSwitch(screens.init, screens.loading, function () {
            $.getJSON(api + "cgi-bin/artist.py", "artist={0}".format(artist), function (resp) {
                if (resp.success) {
                    divSwitch(screens.loading, screens.game, function () {
                        $("#game_artistName").html(resp.content.name);
                        $("#game_artistInfo").html(resp.content.biography.replace("\n\n", "<p>&nbsp;</p>"));
                        doGetPuzzle(resp.content.name, 3, 3);
                    });
                } else {
                    divSwitch(screens.loading, screens.init, function () {
                        var artistName = $("#init_artistName");
                        artistName.bsValidateError();
                        artistName.focus();
                    })
                }
            });
        });
    }

    $(document).on("click", "#init_doSearch", function () {
        handle_doSearch($("#"))
    }

    $(document).on("keydown", "input", function (e) {
        if (e.keyCode == 13) {
            $("a[data-submit=" + $(this).attr('data-form') + "]").click();
        }
    });

    $(document).on("keydown", function (e) {
        if (e.keyCode == 37) {
            //Left//
            if (pos[0] > 0) {
                movePiece(pos[0], pos[1], pos[0] - 1, pos[1]);
            }
        } else if (e.keyCode == 38) {
            //Up//
            if (pos[1] > 0) {
                movePiece(pos[0], pos[1], pos[0], pos[1] - 1);
            }
        } else if (e.keyCode == 39) {
            //Left//
            if (pos[0] < cols - 1) {
                movePiece(pos[0], pos[1], pos[0] + 1, pos[1]);
            }
        } else if (e.keyCode == 40) {
            //Down//
            if (pos[1] < rows - 1) {
                movePiece(pos[0], pos[1], pos[0], pos[1] + 1);
            }
        }
    });

    function movePiece(cI, rI, cF, rF) {
        var current = $("td[data-row=" + rI + "][data-col=" + cI + "]");
        var final = $("td[data-row=" + rF + "][data-col=" + cF + "]");

        current.html(final.html());
        final.html("");

        pos = [cF, rF];
    }
</script>
</body>
</html>